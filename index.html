<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Preview Widget Din√¢mico</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Imports do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Vari√°veis globais
        let db;
        let auth;
        let userId;

        // =================================================================
        // üöÄ DADOS DO VOO A PESQUISAR (EDITAR AQUI) üöÄ
        // =================================================================
        // Ao mudar este c√≥digo e recarregar, o widget buscar√° os novos dados do voo no Google
        const FLIGHT_CODE = 'LA8098'; 
        // =================================================================

        // Template de status e progresso (L√≥gica da Aplica√ß√£o, n√£o vem da API)
        const STATUS_TEMPLATE = {
            statusIndex: 0, // 0: Scheduled, 1: Departed, 2: In Flight, 3: Landed
            statusMap: ["DEPARTING ON TIME", "DEPARTED", "IN FLIGHT", "LANDED"],
            progressMap: [0.0, 0.05, 0.5, 1.0], // Posi√ß√£o do avi√£o no mapa (0.0 a 1.0)
            statusColorMap: ["bg-green-600", "bg-blue-600", "bg-yellow-600", "bg-gray-600"],
            originTerminal: "3", // Dados mockados que n√£o s√£o f√°ceis de obter via pesquisa simples
            originGate: "-",
            updatedTime: "6h 38m ago",
        };

        // Regra de armazenamento: /artifacts/{appId}/public/data/{your_collection_name}/{documentId}
        const flightDocRef = (db, appId) => doc(db, `artifacts/${appId}/public/data/flight_status`, FLIGHT_CODE);

        // Configura√ß√µes e Inicializa√ß√£o do Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const API_KEY = ""; // A chave √© injetada automaticamente, mas mantemos o placeholder

        // =================================================================
        // üåê FUN√á√ïES DE INTEGRA√á√ÉO COM GEMINI API E GOOGLE SEARCH üåê
        // =================================================================

        const flightSchema = {
            type: "OBJECT",
            properties: {
                "airline": { "type": "STRING", "description": "Nome da companhia a√©rea (ex: LATAM)" },
                "flightNumber": { "type": "STRING", "description": "C√≥digo completo do voo (ex: LA8098)" },
                "originCity": { "type": "STRING", "description": "Cidade de origem (ex: S√£o Paulo)" },
                "originCode": { "type": "STRING", "description": "C√≥digo IATA de origem (ex: GRU)" },
                "destinationCity": { "type": "STRING", "description": "Cidade de destino (ex: Madrid)" },
                "destinationCode": { "type": "STRING", "description": "C√≥digo IATA de destino (ex: MAD)" },
                "departureTime": { "type": "STRING", "description": "Hor√°rio de partida agendado no formato HH:MM (ex: 18:00)" },
                "arrivalTime": { "type": "STRING", "description": "Hor√°rio de chegada agendado no formato HH:MM (ex: 10:30)" },
                "departureDate": { "type": "STRING", "description": "Data de partida em formato amig√°vel (ex: Tue, Nov 25)" },
                "duration": { "type": "STRING", "description": "Dura√ß√£o total do voo (ex: 10h 30m)" },
            },
            required: ["airline", "flightNumber", "originCity", "originCode", "destinationCity", "destinationCode", "departureTime", "arrivalTime", "departureDate", "duration"],
        };
        
        // Tenta a chamada da API com retentativas (exponential backoff)
        async function fetchWithRetry(url, options, maxRetries = 5) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempt++;
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) {
                        throw error;
                    }
                }
            }
        }

        // Pesquisa os dados do voo usando a API e o Google Search
        async function searchAndParseFlightData(flightCode) {
            const systemPrompt = "Voc√™ √© um analista de dados de voo. Dada uma consulta de voo, use a pesquisa do Google para encontrar os detalhes do voo e retorne *apenas* um objeto JSON com o formato fornecido. Se um dado n√£o puder ser encontrado, use um h√≠fen (-) como valor. Voc√™ deve ser capaz de preencher todos os campos.";
            const userQuery = `Encontre os detalhes de rota e hor√°rio para o voo ${flightCode}.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: flightSchema,
                }
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            
            try {
                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonString) {
                    throw new Error("Resposta da API vazia ou malformada.");
                }

                const parsedData = JSON.parse(jsonString);
                console.log("Dados do voo obtidos via Google/Gemini:", parsedData);
                return parsedData;

            } catch (error) {
                console.error("Erro ao buscar dados do voo com a API:", error);
                // Retorna um objeto com falha para o fallback
                return { 
                    error: true,
                    flightNumber: flightCode, 
                    originCity: "ERRO DE BUSCA", 
                    destinationCity: "ERRO DE BUSCA",
                    airline: "Desconhecida",
                    originCode: "???",
                    destinationCode: "???",
                    departureTime: "--:--",
                    arrivalTime: "--:--",
                    departureDate: "Data Desconhecida",
                    duration: "Tempo Desconhecido",
                };
            }
        }

        // =================================================================
        // üíæ FUN√á√ïES DE FIREBASE E ATUALIZA√á√ÉO DO DOM üíæ
        // =================================================================

        // Fun√ß√£o principal de inicializa√ß√£o do Firebase
        async function initFirebase() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase configuration is missing.");
                    // Fallback visual
                    updateDOM({ ...STATUS_TEMPLATE, ...{ 
                        flightNumber: FLIGHT_CODE,
                        originCity: "Firebase Desligado", 
                        destinationCity: "Usando Mock", 
                        originCode: "MOC", 
                        destinationCode: "KED", 
                        departureTime: "00:00",
                        arrivalTime: "00:00",
                        departureDate: "Mock",
                        duration: "0h 0m",
                        airline: "MockAir",
                    }});
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized. User ID:", userId);

                await initializeFlightState();
                setupRealtimeListener();

            } catch (error) {
                console.error("Erro na inicializa√ß√£o do Firebase:", error);
                document.getElementById('flight-status-badge').textContent = "ERRO FATAL";
            }
        }

        // Fun√ß√£o para garantir que o documento existe e √© inicializado (com busca no Google)
        async function initializeFlightState() {
            const docRef = flightDocRef(db, appId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                console.log(`Documento ${FLIGHT_CODE} n√£o existe. Buscando dados do voo no Google...`);
                
                // 1. Busca os dados externos
                const flightDataFromGoogle = await searchAndParseFlightData(FLIGHT_CODE);

                // 2. Combina com o template de status interno
                const initialData = {
                    ...flightDataFromGoogle, 
                    ...STATUS_TEMPLATE
                };
                
                // 3. Salva no Firestore
                await setDoc(docRef, initialData);
                console.log(`Estado inicial do voo ${FLIGHT_CODE} salvo no Firestore.`);
            }
        }

        // Fun√ß√£o para atualizar o DOM com os dados do Firestore
        function updateDOM(data) {
            // Se houver erro na busca, exibe o erro
            if (data.error) {
                 document.getElementById('flight-status-badge').textContent = data.originCity;
                 document.getElementById('flight-status-badge').className = "inline-block px-2 py-0.5 text-xs font-semibold rounded-full text-white tracking-widest bg-red-600";
            }

            const statusText = data.statusMap[data.statusIndex];
            const statusClass = data.statusColorMap[data.statusIndex];
            const progress = data.progressMap[data.statusIndex];

            // 1. T√≠tulos e Subt√≠tulos
            document.getElementById('flight-title').textContent = `${data.airline} ${data.flightNumber}`;
            document.getElementById('flight-subtitle').textContent = `${data.originCity} to ${data.destinationCity}`;
            
            // 2. Badge de Status
            const statusBadge = document.getElementById('flight-status-badge');
            statusBadge.textContent = statusText;
            const currentStatusClass = data.statusIndex === 0 ? 'bg-status-on-time-bg' : statusClass; 
            statusBadge.className = `inline-block px-2 py-0.5 text-xs font-semibold rounded-full text-white tracking-widest ${currentStatusClass}`;

            // 3. Rota
            document.getElementById('origin-code').textContent = data.originCode;
            document.getElementById('destination-code').textContent = data.destinationCode;
            document.getElementById('flight-duration').textContent = data.duration;
            
            // 4. Detalhes de Hor√°rio
            document.getElementById('departure-time').textContent = data.departureTime;
            document.getElementById('arrival-time').textContent = data.arrivalTime;
            document.getElementById('origin-terminal').textContent = data.originTerminal;
            document.getElementById('origin-gate').textContent = data.originGate;
            document.getElementById('origin-date').textContent = `${data.originCity} ‚Ä¢ ${data.departureDate}`;
            document.getElementById('destination-date').textContent = `${data.destinationCity} ‚Ä¢ ${data.departureDate}`;

            // 5. Rodap√©
            document.getElementById('updated-time').textContent = data.updatedTime;
            
            // 6. Atualizar Posi√ß√£o do Avi√£o
            const planeIcon = document.getElementById('plane-icon-wrapper');
            const position = progress * 100;
            planeIcon.style.left = `${Math.min(95, Math.max(5, position))}%`; 
            
            // Atualiza a barra de progresso visual
            const pathProgress = document.getElementById('flight-path-progress');
            pathProgress.style.width = `${progress * 100}%`;
            
            // Atualiza o flight number mock no bloco 2. Detalhes de Status e Tempo
            document.getElementById('flight-number-mock').textContent = data.flightNumber;
            document.getElementById('departure-time-mock').textContent = data.departureTime;
        }

        // Fun√ß√£o para escutar as mudan√ßas no Firestore (Atualiza√ß√£o Autom√°tica)
        function setupRealtimeListener() {
            const docRef = flightDocRef(db, appId);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateDOM(data);
                } else {
                    console.log("Documento n√£o encontrado. Inicializando...");
                    // Se o documento for exclu√≠do no Firestore, ele ser√° reinicializado.
                    initializeFlightState(); 
                }
            }, (error) => {
                console.error("Erro no listener de tempo real:", error);
            });
        }

        // Inicia o Firebase e o aplicativo
        initFirebase();
        
    </script>
    <!-- Configura√ß√£o customizada do Tailwind para um tema escuro elegante (Apple-like) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Cores atualizadas
                        'dark-bg': '#1C1C1E', 
                        'card-bg': '#2C2C2E', // Fundo mais claro, como o do Notion no dark mode
                        'text-primary': '#FFFFFF',
                        'text-secondary': '#8D8D92', 
                        'status-on-time-text': '#34C759', // Novo verde vibrante para texto e √≠cones
                        'status-on-time-bg': '#10522B', // Fundo escuro sutil para a badge de status
                        'line-color': '#555555', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Define a fonte Inter como padr√£o e remove margens */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: auto; 
            padding: 0;
            background-color: #1C1C1E;
        }
        
        /* Estilo para simular o mapa com um gradiente simples */
        .route-path {
            position: relative;
        }

        /* Estilo para a linha da rota */
        .route-line {
            position: absolute;
            top: 50%;
            left: 12%; /* In√≠cio depois do GRU */
            right: 12%; /* Fim antes do LIM */
            height: 2px;
            background-color: #555555; /* Linha de fundo sutil */
            transform: translateY(-50%);
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- Cart√£o de Pr√©-visualiza√ß√£o de Voo (M√°ximo 400px de largura para parecer um widget) -->
    <div id="flight-card" class="bg-card-bg text-text-primary rounded-xl shadow-2xl w-full max-w-lg overflow-hidden border border-[#3C3C3E]">
        
        <!-- 1. T√≠tulo e Subt√≠tulo -->
        <div class="p-4 flex flex-col border-b border-gray-700">
            <div class="flex justify-between items-center mb-1">
                <h1 id="flight-title" class="text-xl font-bold">LATAM LA 8098</h1>
                <div class="text-text-secondary cursor-pointer">
                    <!-- Icone de menu de 3 pontos (‚Ä¢‚Ä¢‚Ä¢) -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                    </svg>
                </div>
            </div>
            <p id="flight-subtitle" class="text-sm text-text-secondary">S√£o Paulo to Lima</p>
        </div>

        <!-- 2. Detalhes de Status e Tempo -->
        <div class="p-4 border-b border-gray-700 space-y-3">
            <div class="flex items-end justify-between text-xs text-text-secondary">
                <!-- Apenas mock para as abas de data -->
                <span class="font-normal">Sun, Nov 23</span>
                <span class="font-semibold border-b-2 border-white pb-1">Tue, Nov 25</span>
            </div>

            <div class="flex items-center justify-between mt-2">
                <div class="flex flex-col">
                    <span id="departure-time-mock" class="text-lg font-semibold text-text-primary">07:30</span>
                    <span id="flight-number-mock" class="text-sm text-text-secondary">LA 8098</span>
                </div>

                <div class="flex items-center space-x-2 text-sm">
                    <span class="text-text-secondary">to <span id="destination-code-mock" class="font-bold">LIM</span></span>
                    <!-- Badge de Status com cor de fundo customizada (status-on-time-bg) -->
                    <span id="flight-status-badge" class="inline-block px-2 py-0.5 text-xs font-semibold rounded-full text-white tracking-widest bg-status-on-time-bg">DEPARTING ON TIME</span>
                    <div class="text-text-secondary cursor-pointer">
                        <!-- √çcone de seta para cima para simular expans√£o -->
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Rota GRU - LIM (Visual Principal) -->
        <div class="route-path p-4 flex justify-between items-center relative">
            
            <!-- Dura√ß√£o do Voo (Centralizado) -->
            <div class="absolute inset-x-0 top-1/4 text-center text-xs text-text-secondary">
                <span id="flight-duration">5h 0m</span>
            </div>

            <!-- Linha de Rota -->
            <div class="route-line"></div>
            <!-- Progress Path (cor da linha de fundo) -->
            <div id="flight-path-progress" class="absolute top-1/2 -mt-px h-0.5 bg-line-color transition-all duration-1000 ease-in-out" style="width: 0;"></div>


            <!-- GRU (Origem) -->
            <div class="text-left z-10">
                <p id="origin-code" class="text-6xl font-extrabold tracking-tight">GRU</p>
                <p class="text-xs text-text-secondary mt-1">Airport info</p>
            </div>
            
            <!-- √çcone do Avi√£o (Posi√ß√£o din√¢mica, cor do novo verde) -->
             <div id="plane-icon-wrapper" class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 transition-all duration-1000 ease-in-out" style="left: 5%;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90 text-status-on-time-text drop-shadow-lg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </div>

            <!-- LIM (Destino) -->
            <div class="text-right z-10">
                <p id="destination-code" class="text-6xl font-extrabold tracking-tight">LIM</p>
                <p class="text-xs text-text-secondary mt-1">Airport info</p>
            </div>
        </div>

        <!-- 4. Tabela de Detalhes -->
        <div class="p-4 pt-0 border-b border-gray-700">
            <div class="grid grid-cols-2 gap-4">
                <!-- Coluna da Partida (GRU) -->
                <div>
                    <p id="origin-date" class="text-base font-semibold text-text-primary">S√£o Paulo ‚Ä¢ Tue, Nov 25</p>
                    <div class="grid grid-cols-3 gap-1 mt-2 text-sm">
                        <span class="text-text-secondary">Scheduled departure</span>
                        <span class="text-text-secondary">Terminal</span>
                        <span class="text-text-secondary">Gate</span>
                    </div>
                    <div class="grid grid-cols-3 gap-1 mt-1 text-base font-bold">
                        <!-- Hor√°rio com o novo verde vibrante -->
                        <span id="departure-time" class="text-status-on-time-text">07:30</span>
                        <span id="origin-terminal" class="text-text-primary">3</span>
                        <span id="origin-gate" class="text-text-primary">-</span>
                    </div>
                </div>

                <!-- Coluna da Chegada (LIM) -->
                <div>
                    <p id="destination-date" class="text-base font-semibold text-text-primary">Lima ‚Ä¢ Tue, Nov 25</p>
                    <div class="grid grid-cols-3 gap-1 mt-2 text-sm">
                        <span class="text-text-secondary">Scheduled arrival</span>
                        <span class="text-text-secondary">Terminal</span>
                        <span class="text-text-secondary">Gate</span>
                    </div>
                    <div class="grid grid-cols-3 gap-1 mt-1 text-base font-bold">
                         <!-- Hor√°rio com o novo verde vibrante -->
                        <span id="arrival-time" class="text-status-on-time-text">10:30</span>
                        <span id="destination-terminal" class="text-text-primary">-</span>
                        <span id="destination-gate" class="text-text-primary">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. Rodap√© (Atualiza√ß√£o e Fonte) -->
        <div class="p-4 flex justify-between items-center text-xs text-text-secondary">
            <span class="text-sm">
                Updated <span id="updated-time">6h 38m ago</span>
            </span>
            <div class="flex items-center space-x-2">
                <span class="text-sm">Source: <a href="#" class="text-blue-400 hover:underline">OAG</a></span>
                <!-- √çcone de compartilhamento -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 cursor-pointer">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75v-2.25M15.75 9l-3 3m0 0-3-3m3 3V1.5" />
                </svg>
            </div>
        </div>

        <!-- Linha de Fundo do Rodap√© -->
        <div class="p-2 text-center text-xs text-text-secondary border-t border-gray-700">
            Showing local airport times
        </div>

    </div>
</body>
</html>
