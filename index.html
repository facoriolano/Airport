<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Preview Widget Dinâmico</title>
    <!-- Carrega Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Imports do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais (disponíveis apenas dentro deste módulo)
        let db;
        let auth;
        let userId;
        const FLIGHT_CODE = 'LA8202';
        const flightDocRef = (db, appId) => doc(db, `artifacts/${appId}/public/data/flight_status`, FLIGHT_CODE);

        // Configurações e Inicialização
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Função principal de inicialização
        async function initFirebase() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase configuration is missing.");
                    // Define dados mockados se o Firebase não estiver configurado
                    updateDOM(MOCK_INITIAL_DATA); 
                    return;
                }
                
                // Configuração e Inicialização
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug'); // Descomente para debug

                // Autenticação
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized. User ID:", userId);

                // 1. Inicializa o estado do voo se não existir
                await initializeFlightState();

                // 2. Configura o listener em tempo real
                setupRealtimeListener();

            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                document.getElementById('flight-status-badge').textContent = "Erro de Conexão";
            }
        }

        // Estado inicial mockado do voo (para inicialização e fallback)
        const MOCK_INITIAL_DATA = {
            airline: "LATAM",
            flightNumber: "LA 8202",
            originCity: "São Paulo",
            originCode: "GRU",
            originTerminal: "3",
            originGate: "-",
            destinationCity: "Lima",
            destinationCode: "LIM",
            departureDate: "Tue, Nov 25",
            departureTime: "07:30",
            arrivalTime: "10:30",
            duration: "5h 0m",
            updatedTime: "6h 38m ago",
            // 0: Scheduled, 1: Departed, 2: In Flight, 3: Landed
            statusIndex: 0, 
            statusMap: ["DEPARTING ON TIME", "DEPARTED", "IN FLIGHT", "LANDED"],
            progressMap: [0.0, 0.05, 0.5, 1.0], // Posição do avião no mapa (0.0 a 1.0)
            statusColorMap: ["bg-green-700/80", "bg-blue-700/80", "bg-yellow-600/80", "bg-gray-600/80"],
        };

        // Função para garantir que o documento existe e é inicializado
        async function initializeFlightState() {
            const docRef = flightDocRef(db, appId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                console.log("Inicializando estado do voo no Firestore...");
                await setDoc(docRef, MOCK_INITIAL_DATA);
            }
        }

        // Função para atualizar o DOM com os dados do Firestore
        function updateDOM(data) {
            const statusText = data.statusMap[data.statusIndex];
            const statusClass = data.statusColorMap[data.statusIndex];
            const progress = data.progressMap[data.statusIndex];

            // 1. Títulos e Subtítulos
            document.getElementById('flight-title').textContent = `${data.airline} ${data.flightNumber}`;
            document.getElementById('flight-subtitle').textContent = `${data.originCity} to ${data.destinationCity}`;
            
            // 2. Badge de Status
            const statusBadge = document.getElementById('flight-status-badge');
            statusBadge.textContent = statusText;
            statusBadge.className = `inline-block px-2 py-0.5 text-xs font-semibold rounded-full text-white tracking-widest ${statusClass}`;

            // 3. Rota
            document.getElementById('origin-code').textContent = data.originCode;
            document.getElementById('destination-code').textContent = data.destinationCode;
            document.getElementById('flight-duration').textContent = data.duration;
            
            // 4. Detalhes de Horário
            document.getElementById('departure-time').textContent = data.departureTime;
            document.getElementById('arrival-time').textContent = data.arrivalTime;
            document.getElementById('origin-terminal').textContent = data.originTerminal;
            document.getElementById('origin-gate').textContent = data.originGate;
            // No design, a data de partida/chegada está repetida, então usamos só a data de partida para ambas
            document.getElementById('origin-date').textContent = `${data.originCity} • ${data.departureDate}`;
            document.getElementById('destination-date').textContent = `${data.destinationCity} • ${data.departureDate}`;

            // 5. Rodapé
            document.getElementById('updated-time').textContent = data.updatedTime;
            
            // 6. Atualizar Posição do Avião
            const planeIcon = document.getElementById('plane-icon-wrapper');
            // Mapeia o progresso (0.0 a 1.0) para uma posição horizontal (0% a 100% menos o tamanho do ícone)
            const position = progress * 100;
            // O avião se move ao longo da linha entre GRU (left: 10%) e LIM (right: 90%)
            planeIcon.style.left = `${Math.min(95, Math.max(5, position))}%`; 
            
            // Atualiza a barra de progresso visual
            const pathProgress = document.getElementById('flight-path-progress');
            pathProgress.style.width = `${progress * 100}%`;
        }

        // Função para escutar as mudanças no Firestore (Atualização Automática)
        function setupRealtimeListener() {
            const docRef = flightDocRef(db, appId);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateDOM(data);
                } else {
                    console.log("Documento não encontrado. Inicializando...");
                    initializeFlightState();
                }
            }, (error) => {
                console.error("Erro no listener de tempo real:", error);
            });
        }

        // Inicia o Firebase e o aplicativo
        initFirebase();
        
    </script>
    <!-- Configuração customizada do Tailwind para um tema escuro elegante (Apple-like) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Cores do novo design (mais escuras)
                        'dark-bg': '#1C1C1E', // Fundo principal
                        'card-bg': '#000000', // Fundo do cartão (preto total para contraste)
                        'text-primary': '#FFFFFF', // Texto principal
                        'text-secondary': '#8D8D92', // Texto secundário (cinza claro)
                        'status-green': '#34C759', // Cor verde para "07:30"
                        'line-color': '#555555', // Cinza para a linha da rota
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Define a fonte Inter como padrão e remove margens */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            /* Garante que o widget não fique fixo na tela para embed no Notion/GitHub */
            min-height: auto; 
            padding: 0;
            background-color: #1C1C1E;
        }
        
        /* Estilo para simular o mapa com um gradiente simples */
        .route-path {
            position: relative;
        }

        /* Estilo para a linha da rota */
        .route-line {
            position: absolute;
            top: 50%;
            left: 12%; /* Início depois do GRU */
            right: 12%; /* Fim antes do LIM */
            height: 2px;
            background-color: #555555; /* Linha de fundo sutil */
            transform: translateY(-50%);
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- Cartão de Pré-visualização de Voo (Máximo 400px de largura para parecer um widget) -->
    <div id="flight-card" class="bg-card-bg text-text-primary rounded-xl shadow-2xl w-full max-w-lg overflow-hidden border border-[#2c2c2e]">
        
        <!-- 1. Título e Subtítulo -->
        <div class="p-4 flex flex-col border-b border-gray-800">
            <div class="flex justify-between items-center mb-1">
                <h1 id="flight-title" class="text-xl font-bold">LATAM LA 8202</h1>
                <div class="text-text-secondary cursor-pointer">
                    <!-- Icone de menu de 3 pontos (•••) -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                    </svg>
                </div>
            </div>
            <p id="flight-subtitle" class="text-sm text-text-secondary">São Paulo to Lima</p>
        </div>

        <!-- 2. Detalhes de Status e Tempo -->
        <div class="p-4 border-b border-gray-800 space-y-3">
            <div class="flex items-end justify-between text-xs text-text-secondary">
                <!-- Apenas mock para as abas de data -->
                <span class="font-normal">Sun, Nov 23</span>
                <span class="font-semibold border-b-2 border-white pb-1">Tue, Nov 25</span>
            </div>

            <div class="flex items-center justify-between mt-2">
                <div class="flex flex-col">
                    <span id="departure-time-mock" class="text-lg font-semibold text-text-primary">07:30</span>
                    <span id="flight-number-mock" class="text-sm text-text-secondary">LA 8202</span>
                </div>

                <div class="flex items-center space-x-2 text-sm">
                    <span class="text-text-secondary">to Lima <span class="font-bold">LIM</span></span>
                    <span id="flight-status-badge" class="inline-block px-2 py-0.5 text-xs font-semibold rounded-full text-white tracking-widest bg-green-700/80">DEPARTING ON TIME</span>
                    <div class="text-text-secondary cursor-pointer">
                        <!-- Ícone de seta para cima para simular expansão -->
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Rota GRU - LIM (Visual Principal) -->
        <div class="route-path p-4 flex justify-between items-center relative">
            
            <!-- Duração do Voo (Centralizado) -->
            <div class="absolute inset-x-0 top-1/4 text-center text-xs text-text-secondary">
                <span id="flight-duration">5h 0m</span>
            </div>

            <!-- Linha de Rota -->
            <div class="route-line"></div>
            <div id="flight-path-progress" class="absolute top-1/2 -mt-px h-0.5 bg-line-color transition-all duration-1000 ease-in-out" style="width: 0;"></div>


            <!-- GRU (Origem) -->
            <div class="text-left z-10">
                <p id="origin-code" class="text-6xl font-extrabold tracking-tight">GRU</p>
                <p class="text-xs text-text-secondary mt-1">Airport info</p>
            </div>
            
            <!-- Ícone do Avião (Posição dinâmica) -->
             <div id="plane-icon-wrapper" class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 transition-all duration-1000 ease-in-out" style="left: 5%;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90 text-status-green drop-shadow-lg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </div>

            <!-- LIM (Destino) -->
            <div class="text-right z-10">
                <p id="destination-code" class="text-6xl font-extrabold tracking-tight">LIM</p>
                <p class="text-xs text-text-secondary mt-1">Airport info</p>
            </div>
        </div>

        <!-- 4. Tabela de Detalhes -->
        <div class="p-4 pt-0 border-b border-gray-800">
            <div class="grid grid-cols-2 gap-4">
                <!-- Coluna da Partida (GRU) -->
                <div>
                    <p id="origin-date" class="text-base font-semibold text-text-primary">São Paulo • Tue, Nov 25</p>
                    <div class="grid grid-cols-3 gap-1 mt-2 text-sm">
                        <span class="text-text-secondary">Scheduled departure</span>
                        <span class="text-text-secondary">Terminal</span>
                        <span class="text-text-secondary">Gate</span>
                    </div>
                    <div class="grid grid-cols-3 gap-1 mt-1 text-base font-bold">
                        <span id="departure-time" class="text-status-green">07:30</span>
                        <span id="origin-terminal" class="text-text-primary">3</span>
                        <span id="origin-gate" class="text-text-primary">-</span>
                    </div>
                </div>

                <!-- Coluna da Chegada (LIM) -->
                <div>
                    <p id="destination-date" class="text-base font-semibold text-text-primary">Lima • Tue, Nov 25</p>
                    <div class="grid grid-cols-3 gap-1 mt-2 text-sm">
                        <span class="text-text-secondary">Scheduled arrival</span>
                        <span class="text-text-secondary">Terminal</span>
                        <span class="text-text-secondary">Gate</span>
                    </div>
                    <div class="grid grid-cols-3 gap-1 mt-1 text-base font-bold">
                        <span id="arrival-time" class="text-status-green">10:30</span>
                        <span id="destination-terminal" class="text-text-primary">-</span>
                        <span id="destination-gate" class="text-text-primary">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. Rodapé (Atualização e Fonte) -->
        <div class="p-4 flex justify-between items-center text-xs text-text-secondary">
            <span class="text-sm">
                Updated <span id="updated-time">6h 38m ago</span>
            </span>
            <div class="flex items-center space-x-2">
                <span class="text-sm">Source: <a href="#" class="text-blue-500 hover:underline">OAG</a></span>
                <!-- Ícone de compartilhamento -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 cursor-pointer">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75v-2.25M15.75 9l-3 3m0 0-3-3m3 3V1.5" />
                </svg>
            </div>
        </div>

        <!-- Linha de Fundo do Rodapé -->
        <div class="p-2 text-center text-xs text-text-secondary border-t border-gray-800">
            Showing local airport times
        </div>

    </div>
</body>
</html>
